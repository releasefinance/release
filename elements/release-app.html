<link href='http://fonts.googleapis.com/css?family=Roboto:400,700,300' rel='stylesheet' type='text/css'>
<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-in-animation.html">
<link rel="import" href="../bower_components/neon-animation/animations/fade-out-animation.html">
<link rel="import" href="../bower_components/paper-input/paper-input.html">
<link rel="import" href="../bower_components/paper-input/paper-input-container.html">
<link rel="import" href="../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../bower_components/paper-spinner/paper-spinner.html">


<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="./budget-page.html">
<link rel="import" href="./shares-page.html">
<link rel="import" href="./quote-page.html">
<link rel="import" href="./main-page.html">
<link rel="import" href="./car-type-page.html">

<dom-module id="release-app" >
  <style shim-shadowdom>
    * {
      font-family: input, sans-serif;
    }
    :root {
      padding: 10px;
    }

    .centered {
      text-align: center;
    }

  </style>
  <template>
    <div class="body-bg"></div>

    <iron-a11y-keys target="[[keysTarget]]" keys="enter" on-keys-pressed="forward"></iron-a11y-keys>
    <neon-animated-pages selected="{{page}}" class="flex layout vertical" transition="cross-fade" entry-animation="fade-in-animation" exit-animation="fade-out-animation">

      <budget-page budget="{{budget}}" on-forward="forward" class="center-justified flex layout vertical"></budget-page>

      <shares-page shares="{{shares}}" on-forward="forward" class="center-justified flex layout vertical"></shares-page>

      <car-type-page types="{{car_types}}" chosen_types="{{chosen_types}}" on-forward="forward" class="center-justified flex layout vertical"></car-type-page>

      <div class="flex layout horizontal">
        <div class="flex self-center centered">
          <h2>Searching for cars</h2>
          <paper-spinner active></paper-spinner>
        </div>
      </div>

      <main-page shares="{{shares}}" budget="{{budget}}" on-forward="forward" cars="{{cars}}" car="{{car}}" class="center-justified flex layout vertical" on-show-quote="showQuote" car_types="[[car_ types]]" chosen_types="[[chosen_types]]" on-another="anotherSearch"></main-page>

      <quote-page first_name="{{first_name}}" last_name="{{last_name}}" email="{{email}}" car="{{car}}" class="layout vertical flex" on-cancel-quote="cancelQuote" on-thanks-quote="thanksQuote"></quote-page>

      <div id="thanks" class="layout horizontal flex">
        <div class="flex thanks-message centered self-center">
          <h3>Thanks!<br />Weâ€™ll be in touch</h3>
        </div>
      </div>

    </neon-animated-pages>
  </template>
</dom-module>
<script>
  Polymer({
    is: "release-app",

    properties: {
      page: {
        type: Number,
        value: 0
      },
      first_name: String,
      last_name: String,
      email: {
        type: String,
        value: ""
      },
      postcode: String,
      budget: Number,
      shares: Number,
      car_type: String,
      car: Object,

      pages: {
        type: Array,
        value: ["budget", "shares", "car_type", "searching", "listing","quote", "thanks"]
      },

      chosen_types: {
        type: Array,
        value: [],
        observer: 'chosen_types_changed'
      },

      car_types: {
        type: Object,
        value: {
          suv: true,
          family: true,
          exec: true,
          sports: true,
          saloon: true
        }
      },

      cars: {
        type: Array,
        value: [],
        notify: true
      },

      keysTarget: {
        type: Object,
        value: function() {
          return document.body;
        }
      }
    },

    chosen_types_changed: function(value) {
      console.log('chosen types changed', value);
    },

    forward: function() {
      if(this.page < 4 ) {
        this.page = this.page + 1;
        analytics.page(this.pages[this.page]);
        analytics.page('Page + ' + this.pages[this.page]);
        if(this.page == 3) {
          this.async(function() {
            this.setupCars();
          },1000);
        }
      }
    },
    ready: function() {
      analytics.track('View');
      window.app = this;
      this.budget = 0;
      this.shares = 2;
    },
    setupCars: function() {
      this.async(function() {
        this.set('cars', window.cars.sort(function(a,b) { a.price < b.price }));
        for(var i = 0; i < this.cars.length; i++) {
          this.set('cars.' + i + '.car_types', window.car_types[this.cars[i].model]);
        }
        this.forward();
      });
    },
    showQuote: function(data) {
      this.set('car', data.detail.car);
      if(this.email == "") {
        analytics.track('quote form', {make: this.car.make, model: this.car.model, meta: this.car.meta, price: this.price, discounted_price: this.discounted_price, shares: this.shares});
        this.page = 5;
      } else {
        analytics.track('additional quote', {make: this.car.make, model: this.car.model, meta: this.car.meta, price: this.price, discounted_price: this.discounted_price, shares: this.shares});
        this.thanksQuote();
      }
    },
    cancelQuote: function() {
      this.page = 4;
    },
    trackQuote: function() {
      analytics.track('quote', {make: this.car.make, model: this.car.model, meta: this.car.meta, price: this.price, discounted_price: this.discounted_price, shares: this.shares});
    },
    thanksQuote: function() {
      this.trackQuote();
      this.page = 6;
      this.async(function() {
        this.page = 4;
      }, 3000);
    },
    anotherSearch: function() {
      this.set('page',0);
    }

  });
</script>
